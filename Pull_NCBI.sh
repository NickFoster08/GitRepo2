#!/bin/bash
#SBATCH --job-name=Spain_WL      # Job name
#SBATCH --partition=batch                # Partition (queue) name
#SBATCH --ntasks=1                       # Run on a single CPU
#SBATCH --cpus-per-task=8                # Number of cores per task
#SBATCH --mem=80gb                       # Job memory request
#SBATCH --time=00-12:00:00               # Time limit hrs:min:sec
#SBATCH --output=/scratch/nf26742/scratch/log.%j.out  # Standard output log
#SBATCH --error=/scratch/nf26742/scratch/log.%j.err   # Standard error log

#SBATCH --mail-type=END,FAIL             # Mail events (NONE, BEGIN, END, FAIL, ALL)
#SBATCH --mail-user=nf26742@uga.edu      # Where to send mail

# Specify output directory
OUTDIR="/scratch/nf26742/Spain_WL"

# Create output directory if it doesn't exist
mkdir -p "$OUTDIR"

# Load SRA tools
module load SRA-Toolkit/3.0.3-gompi-2022a
module load EntrezDirect/13.8  # Load EDirect for ncbi queries (adjust module as needed)

# List of accessions
accessions=(
SAMEA117855668
SAMEA117855666
SAMEA117855644
SAMEA117855706
SAMEA117855628
SAMEA117855626
SAMEA117855654
SAMEA117855637
SAMEA117855705
SAMEA117855619
SAMEA117855704
SAMEA117855701
SAMEA117855620
SAMEA117855665
SAMEA117855612
SAMEA117855707
SAMEA117855627
SAMEA117855639
SAMEA117855618
SAMEA117855703
SAMEA117855636
SAMEA117855629
SAMEA117855669
SAMEA117855634
SAMEA117855702
SAMEA117855630
SAMEA117855638
SAMEA117855633
SAMEA117855683
SAMN48099571
SAMN48099570
SAMN48099569
SAMN48099568
SAMN48099567
SAMN48099566
SAMN48099565
SAMN48099563
SAMN48099562
SAMN48099561
SAMN48099558
SAMN48099557
SAMN48099556
SAMN48099555
SAMN48099554
SAMN48099553
SAMN48099552
SAMN48099551
SAMN48099550
SAMN48099549
SAMN48099548
SAMN48099547
SAMN48099546
SAMN48099545
SAMN48099544
SAMN48099543
SAMN48099542
SAMN48099541
SAMN48099539
SAMN48099538
SAMN48099537
SAMN48099536
SAMN48099535
SAMN48099534
SAMN48099533
SAMN48099532
SAMN48099531
SAMN48099530
SAMN48099529
SAMN48099528
SAMN48099527
SAMN48099526
SAMN48099525
SAMN48099524
SAMN46144118
SAMN46144113
SAMN46144112
SAMN46144111
SAMN46144106
SAMN46144105
SAMN46144104
SAMN46144102
SAMN40646641
SAMN40646638
SAMN40646637
SAMN40646636
SAMN40646635
SAMN40646632
SAMN40646629
SAMN40646628
SAMN40646627
SAMN40646625
SAMN40646622
SAMN40646621
SAMN36338274
SAMN36338273
SAMN36338267
SAMN36338266
SAMN36338264
SAMN36338258
SAMN36338253
SAMN30721328
SAMN30721327
SAMN30721326
SAMN30721325
SAMN30721324
SAMN30721323
SAMN30721322
SAMN29871780
SAMN29871779
SAMN29871778
SAMN29871777
SAMN29871776
SAMN29871765
SAMN29871764
SAMN29871763
SAMN29871760
SAMN29871755
SAMN29871754
SAMN29871753
SAMN29871752
SAMN29871751
SAMN29871750
SAMN29871749
SAMN29871748
SAMN29871747
SAMN26814670
SAMN26814663
SAMN26814662
SAMN26814660
SAMN26814658
SAMN26814650
SAMN26814649
SAMN26814648
SAMN26814647
SAMN26814645
SAMN26814644
SAMN26814643
SAMN26814638
SAMN26814637
SAMN26814636
SAMN26814635
SAMN26814633
SAMN26814631
SAMN26814630
SAMN26814615
SAMN26814614
SAMN26814612
SAMN26814602
SAMN26814601
SAMN26814594
SAMN26814578
SAMN26814577
SAMN26814576
SAMN26814563
SAMN26814561
SAMN26814560
SAMN26814554
SAMN26814550
SAMN26814544
SAMN26814543
SAMN26814540
SAMN26814538
SAMN20482616
SAMN20482563
SAMN20482556
SAMN14447208
SAMN14447205
)
for biosample in "${accessions[@]}"; do
    echo "Processing $biosample"

    srr_list=$(esearch -db biosample -query "$biosample" \
        | elink -target sra \
        | efetch -format runinfo \
        | cut -d',' -f1 | grep '^SRR')

    if [[ -z "$srr_list" ]]; then
        echo "‚ö†Ô∏è  No SRR found for $biosample"
        continue
    fi

    for srr in $srr_list; do
        echo "üîÑ Downloading $srr from NCBI"

        fasterq-dump "$srr" -O "$OUTDIR" --threads 8
        if [[ $? -eq 0 ]]; then
            echo "‚úÖ Successfully downloaded and converted $srr"
        else
            echo "‚ö†Ô∏è  NCBI failed, trying ENA for $srr"

            # Get first 6 characters to construct ENA FTP path
            prefix=$(echo "$srr" | cut -c1-6)
            url="https://ftp.sra.ebi.ac.uk/vol1/fastq/${prefix}/${srr}/${srr}_1.fastq.gz"

            wget -P "$OUTDIR" "$url"
            wget -P "$OUTDIR" "${url/_1/_2}"
            
            if [[ -f "$OUTDIR/${srr}_1.fastq.gz" ]]; then
                echo "‚úÖ Downloaded $srr from ENA"
            else
                echo "‚ùå Failed to download $srr from both NCBI and ENA"
            fi
        fi
    done
done